// BSNHS Digital Map - GPS Mapping System
// Coordinates provided for Buenavista Science National High School

// School Campus Boundaries (GPS Coordinates)
const SCHOOL_BOUNDS = {
  // Four corners of the campus
  northWest: { lat: 15.660633, lng: 120.771630 },
  northEast: { lat: 15.660590, lng: 120.772761 },
  southWest: { lat: 15.659713, lng: 120.771591 },
  southEast: { lat: 15.659669, lng: 120.772726 }
};

// Reference Points for Calibration
const REFERENCE_POINTS = {
  gymCenter: { lat: 15.660099, lng: 120.772363 },
  gate: { lat:15.660000926029634, lng:120.77166641165608


   }
};

// GPS MODE: Set to true to use real GPS, false to use gate coordinates (test mode)
// Simple variable - change this to toggle between real GPS and test mode
const USE_REAL_GPS = false; // Set to true for real GPS, false for test mode (gate)

// ============================================================================
// VISUAL PATHWAY TRACING SYSTEM
// Click along black lines on the map to define pathways - NO GPS COORDINATES NEEDED!
// ============================================================================

// Traced pathways - stored as pixel coordinates, converted to GPS when needed
// Format: { id, name, points: [{x, y}, ...] } where x,y are pixel coordinates
const TRACED_PATHWAYS = [
  {
    "id": "pathway_1768698670006",
    "name": "Gate to center",
    "points": [
      {
        "x": 91.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 98.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 103.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 107.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 115.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 120.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 123.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 130.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 133.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 137.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 139.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 147.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 150.59999084472656,
        "y": 431.39999771118164
      },
      {
        "x": 155.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 159.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 162.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 166.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 170.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 175.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 179.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 184.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 187.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 191.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 193.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 197.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 201.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 203.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 211.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 215.59999084472656,
        "y": 431.39999771118164
      },
      {
        "x": 223.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 227.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 231.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 236.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 239.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 243.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 246.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 250.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 255.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 260.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 265.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 270.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 278.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 283.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 288.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 293.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 296.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 300.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 306.59999084472656,
        "y": 431.39999771118164
      },
      {
        "x": 311.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 321.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 331.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 337.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 342.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 347.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 355.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 356.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 364.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 369.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 375.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 383.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 387.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 391.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 399.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 406.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 408.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 411.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 418.59999084472656,
        "y": 433.39999771118164
      },
      {
        "x": 421.59999084472656,
        "y": 433.39999771118164
      }
    ]
  },
  {
    "id": "pathway_1768698849755",
    "name": "Way to guard house",
    "points": [
      {
        "x": 126.59999084472656,
        "y": 432.39999771118164
      },
      {
        "x": 126.59999084472656,
        "y": 434.39999771118164
      },
      {
        "x": 126.59999084472656,
        "y": 436.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 440.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 446.39999771118164
      },
      {
        "x": 126.59999084472656,
        "y": 450.39999771118164
      },
      {
        "x": 126.59999084472656,
        "y": 455.39999771118164
      },
      {
        "x": 126.59999084472656,
        "y": 462.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 465.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 470.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 475.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 480.39999771118164
      },
      {
        "x": 128.59999084472656,
        "y": 486.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 490.39999771118164
      },
      {
        "x": 128.59999084472656,
        "y": 494.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 496.39999771118164
      }
    ]
  },
  {
    "id": "pathway_1768698938148",
    "name": "Guard House Corridor",
    "points": [
      {
        "x": 127.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 127.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 131.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 135.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 139.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 143.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 147.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 151.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 159.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 163.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 169.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 172.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 174.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 178.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 183.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 188.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 192.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 196.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 199.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 207.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 208.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 213.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 216.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 218.59999084472656,
        "y": 496.39999771118164
      },
      {
        "x": 223.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 226.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 230.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 232.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 233.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 239.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 244.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 247.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 249.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 256.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 259.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 266.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 269.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 273.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 275.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 279.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 284.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 288.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 292.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 298.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 303.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 311.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 316.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 320.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 326.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 331.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 338.59999084472656,
        "y": 495.39999771118164
      },
      {
        "x": 342.59999084472656,
        "y": 495.39999771118164
      },
      {
        "x": 348.59999084472656,
        "y": 497.39999771118164
      },
      {
        "x": 355.59999084472656,
        "y": 498.39999771118164
      },
      {
        "x": 359.59999084472656,
        "y": 498.39999771118164
      }
    ]
  },
  {
    "id": "pathway_1768704943540",
    "name": "Guard House Corridor Right",
    "points": [
      {
        "x": 365.36363220214844,
        "y": 497
      },
      {
        "x": 365.36363220214844,
        "y": 500
      },
      {
        "x": 365.36363220214844,
        "y": 505
      },
      {
        "x": 366.36363220214844,
        "y": 509
      },
      {
        "x": 365.36363220214844,
        "y": 513
      },
      {
        "x": 365.36363220214844,
        "y": 517
      },
      {
        "x": 366.36363220214844,
        "y": 522
      }
    ]
  },
  {
    "id": "pathway_1768705090345",
    "name": "Clinic Corridor",
    "points": [
      {
        "x": 367.36363220214844,
        "y": 523
      },
      {
        "x": 373.36363220214844,
        "y": 523
      },
      {
        "x": 378.36363220214844,
        "y": 523
      },
      {
        "x": 385.36363220214844,
        "y": 523
      },
      {
        "x": 389.36363220214844,
        "y": 523
      },
      {
        "x": 393.36363220214844,
        "y": 523
      },
      {
        "x": 397.36363220214844,
        "y": 523
      },
      {
        "x": 401.36363220214844,
        "y": 523
      },
      {
        "x": 405.36363220214844,
        "y": 522
      },
      {
        "x": 409.36363220214844,
        "y": 522
      },
      {
        "x": 413.36363220214844,
        "y": 522
      },
      {
        "x": 418.36363220214844,
        "y": 523
      },
      {
        "x": 424.36363220214844,
        "y": 523
      },
      {
        "x": 429.36363220214844,
        "y": 523
      },
      {
        "x": 433.36363220214844,
        "y": 523
      },
      {
        "x": 437.36363220214844,
        "y": 523
      },
      {
        "x": 442.36363220214844,
        "y": 523
      },
      {
        "x": 448.36363220214844,
        "y": 523
      },
      {
        "x": 452.36363220214844,
        "y": 523
      },
      {
        "x": 457.36363220214844,
        "y": 523
      },
      {
        "x": 461.36363220214844,
        "y": 523
      },
      {
        "x": 469.36363220214844,
        "y": 523
      },
      {
        "x": 475.36363220214844,
        "y": 522
      },
      {
        "x": 479.36363220214844,
        "y": 522
      },
      {
        "x": 483.36363220214844,
        "y": 523
      },
      {
        "x": 488.36363220214844,
        "y": 524
      },
      {
        "x": 492.36363220214844,
        "y": 524
      },
      {
        "x": 498.36363220214844,
        "y": 524
      },
      {
        "x": 501.36363220214844,
        "y": 523
      },
      {
        "x": 505.36363220214844,
        "y": 522
      },
      {
        "x": 509.36363220214844,
        "y": 523
      },
      {
        "x": 513.3636322021484,
        "y": 524
      },
      {
        "x": 518.3636322021484,
        "y": 524
      },
      {
        "x": 525.3636322021484,
        "y": 523
      },
      {
        "x": 530.3636322021484,
        "y": 523
      },
      {
        "x": 536.3636322021484,
        "y": 523
      },
      {
        "x": 541.3636322021484,
        "y": 523
      },
      {
        "x": 546.3636322021484,
        "y": 523
      },
      {
        "x": 552.3636322021484,
        "y": 523
      },
      {
        "x": 558.3636322021484,
        "y": 524
      },
      {
        "x": 563.3636322021484,
        "y": 523
      },
      {
        "x": 568.3636322021484,
        "y": 523
      },
      {
        "x": 571.3636322021484,
        "y": 524
      },
      {
        "x": 575.3636322021484,
        "y": 524
      },
      {
        "x": 578.3636322021484,
        "y": 524
      },
      {
        "x": 583.3636322021484,
        "y": 524
      },
      {
        "x": 588.3636322021484,
        "y": 524
      },
      {
        "x": 591.3636322021484,
        "y": 524
      },
      {
        "x": 596.3636322021484,
        "y": 524
      },
      {
        "x": 600.3636322021484,
        "y": 524
      },
      {
        "x": 606.3636322021484,
        "y": 524
      },
      {
        "x": 610.3636322021484,
        "y": 524
      },
      {
        "x": 616.3636322021484,
        "y": 524
      },
      {
        "x": 622.3636322021484,
        "y": 524
      },
      {
        "x": 626.3636322021484,
        "y": 524
      },
      {
        "x": 632.3636322021484,
        "y": 524
      },
      {
        "x": 638.3636322021484,
        "y": 524
      },
      {
        "x": 642.3636322021484,
        "y": 524
      },
      {
        "x": 648.3636322021484,
        "y": 524
      },
      {
        "x": 651.3636322021484,
        "y": 525
      },
      {
        "x": 658.3636322021484,
        "y": 524
      },
      {
        "x": 667.3636322021484,
        "y": 524
      },
      {
        "x": 672.3636322021484,
        "y": 523
      },
      {
        "x": 679.3636322021484,
        "y": 523
      },
      {
        "x": 681.3636322021484,
        "y": 524
      },
      {
        "x": 686.3636322021484,
        "y": 524
      },
      {
        "x": 690.3636322021484,
        "y": 524
      },
      {
        "x": 695.3636322021484,
        "y": 522
      },
      {
        "x": 701.3636322021484,
        "y": 524
      },
      {
        "x": 706.3636322021484,
        "y": 524
      },
      {
        "x": 710.3636322021484,
        "y": 524
      },
      {
        "x": 715.3636322021484,
        "y": 524
      },
      {
        "x": 721.3636322021484,
        "y": 523
      },
      {
        "x": 725.3636322021484,
        "y": 523
      },
      {
        "x": 730.3636322021484,
        "y": 523
      },
      {
        "x": 736.3636322021484,
        "y": 523
      },
      {
        "x": 739.3636322021484,
        "y": 523
      },
      {
        "x": 744.3636322021484,
        "y": 524
      },
      {
        "x": 750.3636322021484,
        "y": 524
      },
      {
        "x": 755.3636322021484,
        "y": 523
      },
      {
        "x": 758.3636322021484,
        "y": 523
      },
      {
        "x": 762.3636322021484,
        "y": 524
      },
      {
        "x": 766.3636322021484,
        "y": 524
      },
      {
        "x": 769.3636322021484,
        "y": 524
      },
      {
        "x": 776.3636322021484,
        "y": 524
      },
      {
        "x": 783.3636322021484,
        "y": 524
      },
      {
        "x": 785.3636322021484,
        "y": 524
      },
      {
        "x": 788.3636322021484,
        "y": 524
      },
      {
        "x": 792.3636322021484,
        "y": 523
      },
      {
        "x": 800.3636322021484,
        "y": 524
      },
      {
        "x": 805.3636322021484,
        "y": 524
      },
      {
        "x": 807.3636322021484,
        "y": 524
      },
      {
        "x": 812.3636322021484,
        "y": 523
      },
      {
        "x": 816.3636322021484,
        "y": 523
      },
      {
        "x": 821.3636322021484,
        "y": 523
      },
      {
        "x": 826.3636322021484,
        "y": 524
      },
      {
        "x": 831.3636322021484,
        "y": 524
      },
      {
        "x": 836.3636322021484,
        "y": 526
      },
      {
        "x": 840.3636322021484,
        "y": 525
      },
      {
        "x": 843.3636322021484,
        "y": 524
      },
      {
        "x": 848.3636322021484,
        "y": 524
      },
      {
        "x": 855.3636322021484,
        "y": 525
      },
      {
        "x": 859.3636322021484,
        "y": 526
      },
      {
        "x": 864.3636322021484,
        "y": 525
      },
      {
        "x": 867.3636322021484,
        "y": 524
      },
      {
        "x": 872.3636322021484,
        "y": 524
      },
      {
        "x": 878.3636322021484,
        "y": 525
      },
      {
        "x": 882.3636322021484,
        "y": 524
      },
      {
        "x": 886.3636322021484,
        "y": 524
      },
      {
        "x": 888.3636322021484,
        "y": 524
      },
      {
        "x": 890.3636322021484,
        "y": 524
      },
      {
        "x": 893.3636322021484,
        "y": 524
      },
      {
        "x": 901.3636322021484,
        "y": 525
      },
      {
        "x": 904.3636322021484,
        "y": 525
      },
      {
        "x": 906.3636322021484,
        "y": 524
      }
    ]
  },
  {
    "id": "pathway_1768706077755",
    "name": "Clinic Corridor To South",
    "points": [
      {
        "x": 395.18182373046875,
        "y": 522.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 525.6789741516113
      },
      {
        "x": 396.18182373046875,
        "y": 527.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 533.6789741516113
      },
      {
        "x": 396.18182373046875,
        "y": 538.6789741516113
      },
      {
        "x": 396.18182373046875,
        "y": 542.6789741516113
      },
      {
        "x": 396.18182373046875,
        "y": 549.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 554.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 558.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 563.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 570.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 576.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 581.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 589.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 593.6789741516113
      },
      {
        "x": 396.18182373046875,
        "y": 597.6789741516113
      },
      {
        "x": 395.18182373046875,
        "y": 602.6789741516113
      },
      {
        "x": 394.18182373046875,
        "y": 605.6789741516113
      }
    ]
  },
  {
    "id": "pathway_1768706386627",
    "name": "Audrey Corridoer",
    "points": [
      {
        "x": 395.18182373046875,
        "y": 563.6789741516113
      },
      {
        "x": 398.18182373046875,
        "y": 563.6789741516113
      },
      {
        "x": 403.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 407.18182373046875,
        "y": 563.6789741516113
      },
      {
        "x": 410.18182373046875,
        "y": 563.6789741516113
      },
      {
        "x": 416.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 419.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 425.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 431.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 434.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 437.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 443.18182373046875,
        "y": 564.6789741516113
      },
      {
        "x": 447.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 452.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 454.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 458.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 463.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 465.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 473.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 477.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 479.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 483.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 488.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 491.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 493.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 499.18182373046875,
        "y": 562.6789741516113
      },
      {
        "x": 503.18182373046875,
        "y": 563.6789741516113
      },
      {
        "x": 509.18182373046875,
        "y": 561.6789741516113
      },
      {
        "x": 513.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 516.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 519.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 524.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 526.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 533.1818237304688,
        "y": 561.6789741516113
      },
      {
        "x": 541.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 543.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 546.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 552.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 553.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 557.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 562.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 566.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 568.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 574.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 576.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 580.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 583.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 587.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 589.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 594.1818237304688,
        "y": 561.6789741516113
      },
      {
        "x": 599.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 601.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 605.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 608.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 613.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 614.1818237304688,
        "y": 562.6789741516113
      },
      {
        "x": 620.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 621.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 623.1818237304688,
        "y": 563.6789741516113
      },
      {
        "x": 627.1818237304688,
        "y": 563.6789741516113
      }
    ]
  }
];

let isTracingPathway = false;
let currentPathway = null;
let pathwayPoints = [];
let tracingPreview = null;

// ============================================================================
// VISUAL PATHWAY TRACING FUNCTIONS
// ============================================================================

// Start tracing a new pathway - call this in browser console
// Example: startPathwayTracing('Gate to Main Hall')
window.startPathwayTracing = function(name) {
  if (isTracingPathway) {
    console.warn('Already tracing a pathway. Finish current one first.');
    return;
  }
  
  isTracingPathway = true;
  currentPathway = { id: `pathway_${Date.now()}`, name: name || 'Unnamed Pathway' };
  pathwayPoints = [];
  
  console.log(`ðŸŽ¯ Tracing "${currentPathway.name}"`);
  console.log('Click along the black lines on the map to trace the pathway.');
  console.log('Press ESC or call finishPathwayTracing() when done.');
  
  // Create preview element
  if (mapContainer) {
    tracingPreview = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    tracingPreview.style.position = 'absolute';
    tracingPreview.style.top = '0';
    tracingPreview.style.left = '0';
    tracingPreview.style.width = '100%';
    tracingPreview.style.height = '100%';
    tracingPreview.style.pointerEvents = 'none';
    tracingPreview.style.zIndex = '20';
    tracingPreview.setAttribute('class', 'pathway-tracing-preview');
    mapContainer.appendChild(tracingPreview);
  }
  
  // Update info
  if (info) {
    info.innerHTML = `
      <div class="info-hint" style="color: #4285f4; font-weight: bold;">
        ðŸŽ¯ Tracing: "${currentPathway.name}"
      </div>
      <div class="info-hint">Click along the black lines to trace the pathway.</div>
      <div class="info-hint">Press ESC or call finishPathwayTracing() when done.</div>
    `;
  }
  
  // Add ESC key listener
  document.addEventListener('keydown', handleTracingKeyPress);
};

// Finish tracing and save pathway
window.finishPathwayTracing = function() {
  if (!isTracingPathway) {
    console.warn('Not currently tracing a pathway.');
    return;
  }
  
  if (pathwayPoints.length < 2) {
    console.warn('Need at least 2 points to create a pathway.');
    return;
  }
  
  // Save pathway
  currentPathway.points = [...pathwayPoints];
  TRACED_PATHWAYS.push(currentPathway);
  
  console.log(`âœ… Pathway "${currentPathway.name}" saved with ${pathwayPoints.length} points!`);
  console.log('Pathway data:', currentPathway);
  console.log('\n=== COPY THIS TO TRACED_PATHWAYS ARRAY ===');
  console.log(JSON.stringify(currentPathway, null, 2));
  console.log('===========================================\n');
  
  // Clean up
  isTracingPathway = false;
  currentPathway = null;
  pathwayPoints = [];
  
  if (tracingPreview) {
    tracingPreview.remove();
    tracingPreview = null;
  }
  
  document.removeEventListener('keydown', handleTracingKeyPress);
  
  if (info) {
    info.innerHTML = '<div class="info-hint">Pathway saved! Click on map to select destination.</div>';
  }
};

// Handle ESC key to finish tracing
function handleTracingKeyPress(e) {
  if (e.key === 'Escape' && isTracingPathway) {
    finishPathwayTracing();
  }
}

// Draw preview of traced pathway
function drawTracingPreview() {
  if (!tracingPreview || pathwayPoints.length < 2) return;
  
  // Clear previous
  tracingPreview.innerHTML = '';
  
  // Create path
  const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  let pathData = '';
  
  for (let i = 0; i < pathwayPoints.length; i++) {
    const point = pathwayPoints[i];
    if (i === 0) {
      pathData += `M ${point.x} ${point.y}`;
    } else {
      pathData += ` L ${point.x} ${point.y}`;
    }
  }
  
  path.setAttribute('d', pathData);
  path.setAttribute('stroke', '#ff0000');
  path.setAttribute('stroke-width', '4');
  path.setAttribute('fill', 'none');
  path.setAttribute('stroke-linecap', 'round');
  path.setAttribute('stroke-linejoin', 'round');
  path.setAttribute('opacity', '0.8');
  
  tracingPreview.appendChild(path);
  
  // Draw points
  pathwayPoints.forEach((point, i) => {
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    circle.setAttribute('cx', point.x);
    circle.setAttribute('cy', point.y);
    circle.setAttribute('r', i === 0 || i === pathwayPoints.length - 1 ? '5' : '3');
    circle.setAttribute('fill', '#ff0000');
    circle.setAttribute('opacity', '0.9');
    tracingPreview.appendChild(circle);
  });
}

// Location Database
// See LOCATIONS_GUIDE.md for documentation on adding locations
// Dito ka magaaddd ng locations
const LOCATIONS = [
  {
    "name": "Gymnasium",
    "type": "building",
    "lat": 15.660099,
    "lng": 120.772363,
    "category": "facility"
  },
  {
    "name": "School Gate",
    "type": "entrance",
    "lat": 15.659840152344088,
    "lng": 120.77160433315026,
    "category": "entrance"
  },
  {
    "name": "Canteen",
    "type": "facility",
    "lat": 15.660353190420091,
    "lng": 120.77210698235825,
    "category": "facility"
  },
  {
    "name": "Math center",
    "type": "facility",
    "lat": 15.660370,
    "lng":120.771712 ,
    "category": "office"
  },
  {
    "name": "9/10 STE room an deparment",
    "type": "facility",
    "lat": 15.660373,
    "lng":120.771856,
    "category": "office"
  },
   {
    "name": "7-DADAY",
    "type": "facility",
    "lat": 15.659894,
    "lng":120.771731,
    "category": "classroom"
  },
  {
    "name": "7-CHIENE",
    "type": "facility",
    "lat": 15.659894,
    "lng":120.771793,
    "category": "classroom"
  },
  {
    "name": "7-SHIELA",
    "type": "facility",
    "lat": 15.659885,
    "lng":120.771854,
    "category": "classroom"
  },
   {
    "name": "8-MARINEL",
    "type": "facility",
    "lat": 15.659882,
    "lng":120.771922,
    "category": "classroom"
  },
   {
    "name": "clinic",
    "type": "facility",
    "lat": 15.659921,
    "lng":120.771974,
    "category": "office"
  },
  {
    "name": "7-STE",
    "type": "facility",
    "lat": 15.660105,
    "lng":  120.771959,
    "category": "office"
  },
   {
    "name": "7-VIOLY",
    "type": "facility",
    "lat": 15.660284, 
    "lng":    120.771971,
    "category": "office"
  },
  {
    "name": "9-ARNEL",
    "type": "facility",
    "lat": 15.66010852025782,
    "lng":     120.77172311795012,
    "category": "classroom"
  },
  
  {
    "name": "9-ANNALY",
    "type": "facility",
    "lat": 15.660175669022143,
    "lng":     120.77171104800979,
    "category": "classroom"
  },

  {
    "name": "AP-CENTER",
    "type": "facility",
    "lat":15.660222337337345,
    "lng":    120.77171864071039,
    "category": "office"
  },
  
  {
    "name": "9-HELEN",
    "type": "facility",
    "lat":15.660269523586946,
    "lng":   120.77171397606439,
    "category": "classroom"
  },

  {
    "name": "9-CZARINA",
    "type": "facility",
    "lat":15.660325905752389,
    "lng":    120.77171309449176,
    "category": "classroom"
  },

 
{
    "name": "9-RICA MAE",
    "type": "facility",
    "lat":15.660420817841622,
    "lng":    120.77173186995468,
    "category": "classroom"
  },

  {
    "name": "9-AYVAN",
    "type": "facility",
    "lat":15.660431148406124,
    "lng":     120.7717821613729,
    "category": "classroom"
  },


{
    "name": "9-NERI",
    "type": "facility",
    "lat":15.660425983123936,
    "lng":    120.77184318162698,
    "category": "classroom"
  },

  {
    "name": "9-RHEA ",
    "type": "facility",
    "lat":15.660420172181324,
    "lng":     120.77191761292593,
    "category": "classroom"
  },

  {
    "name": "10-MARCO ",
    "type": "facility",
    "lat":15.660489903483061,
    "lng":     120.7717164472532,
    "category": "classroom"
  },

   {
    "name": "10-EOLIA ",
    "type": "facility",
    "lat":15.66049313178344,
    "lng":     120.77179356076111,
    "category": "classroom"
  },

  {
    "name": "10-GLENDA ",
    "type": "facility",
    "lat":15.66049377744351,
    "lng":      120.77184586383605,
    "category": "classroom"
  },

   {
    "name": "10-IMEE ",
    "type": "facility",
    "lat":15.660491840463292,
    "lng":       120.77191157795583,
    "category": "classroom"
  },

  {
    "name": "10-BLESSIE ",
    "type": "facility",
    "lat":15.66049054914425,
    "lng":        120.7719880209212,
    "category": "classroom"
  },

  {
    "name": "10-CLYDE ",
    "type": "facility",
    "lat":15.660487966503915,
    "lng":      120.77205708779739,
    "category": "classroom"
  },

  {
    "name": "10-JOMAR",
    "type": "facility",
    "lat":15.660486029523646,
    "lng":      120.77211475528625,
    "category": "classroom"
  },

  {
    "name": "10-FRANCISCO",
    "type": "facility",
    "lat":15.660480864242844,
    "lng":      120.7721797988493,
    "category": "classroom"
  },

  {
    "name": "8-JENNY",
    "type": "facility",
    "lat":15.660424744283867,
    "lng":      120.77200335293442,
    "category": "classroom"
  },


  {
    "name": "8-JOMAR",
    "type": "facility",
    "lat":15.66042538994414,
    "lng":       120.77206169097548,
    "category": "classroom"
  },

  {
    "name": "8-JOAN",
    "type": "facility",
    "lat":15.66042538994414,
    "lng":      120.77211466459897,
    "category": "classroom"
  },

  {
    "name": "8-JOVINEL",
    "type": "facility",
    "lat":15.66042990956608,
    "lng":     120.77218373147518,
    "category": "classroom"
  },

  {
    "name": "8-JERICO",
    "type": "facility",
    "lat":15.66048764772945,
    "lng":   120.77228406055742,
    "category": "classroom"
  },

  {
    "name": "8-JERICK",
    "type": "facility",
    "lat":15.66048635640926,
    "lng":  120.77233971638972,
    "category": "classroom"
  },

  {
    "name": "8-GINA",
    "type": "facility",
    "lat":15.66048764772945,
    "lng":     120.77239134890881,
    "category": "classroom"
  },

    {
    "name": "8-ANGELICA",
    "type": "facility",
    "lat":15.66048441942898,
    "lng":    120.77246712130696,
    "category": "classroom"
  },

   {
    "name": "8-MAGDALENA",
    "type": "facility",
    "lat":15.660425018691415,
    "lng":     120.7722713200657,
    "category": "classroom"
  },

{
    "name": "8-JOCELYN",
    "type": "facility",
    "lat":15.660423081710547,
    "lng":      120.7723444102551,
    "category": "classroom"
  },

{
    "name": "8-JANINE",
    "type": "facility",
    "lat":15.660420499069371,
    "lng":      120.77240475995274,
    "category": "classroom"
  },

  {
    "name": "8-EMMYLYN",
    "type": "facility",
    "lat":15.660418544881246,
    "lng":      120.77245202339067,
    "category": "classroom"
  },

  {
    "name": "SPG/GUIDANCE",
    "type": "facility",
    "lat":15.659914938112323,
    "lng":      120.77202986284298,
    "category": "classroom"
  },

  {
    "name": "8-MARICEL",
    "type": "facility",
    "lat":15.659917520759898,
    "lng":      120.77216933769976,
    "category": "classroom"
  },

  {
    "name": "7-KIMBERLY",
    "type": "facility",
    "lat":15.659854245885072,
    "lng":      120.77216732604319,
    "category": "classroom"
  },

  {
    "name": "7-CARMELA",
    "type": "facility",
    "lat":15.65985941118171,
    "lng":      120.77210161192797,
    "category": "classroom"
  },

  {
    "name": "7-AUDREY",
    "type": "facility",
    "lat":15.659864576478222,
    "lng":       120.77204327388691,
    "category": "classroom"
  },
  
  {
    "name": "7-ARGEL",
    "type": "facility",
    "lat":15.659800010262483,
    "lng":       120.77202852173859,
    "category": "classroom"
  },

  {
    "name": "7-EDGARDO",
    "type": "facility",
    "lat":15.659800010262483,
    "lng":       120.77209222419721,
    "category": "classroom"
  },

  {
    "name": "7-ARIELITO",
    "type": "facility",
    "lat":15.659802592911497,
    "lng":      120.77215391499925,
    "category": "classroom"
  },

  {
    "name": "7-AGGELITO",
    "type": "facility",
    "lat":15.65970233926698,
    "lng":       120.77203916139378,
    "category": "classroom"
  },

  {
    "name": "COOKERY LAB",
    "type": "facility",
    "lat":15.659907875798028,
    "lng":       120.77227203388799,
    "category": "classroom"
  },

  {
    "name": "8-JAYSON",
    "type": "facility",
    "lat":15.659914018403919,
    "lng":       120.77234300475237,
    "category": "classroom"
  },

  {
    "name": "8-MARIBEL",
    "type": "facility",
    "lat":15.65991478622964,
    "lng":      120.77240998848958,
    "category": "classroom"
  },

 {
    "name": "8-EFREN",
    "type": "facility",
    "lat":15.659913250578185,
    "lng":       120.77246580827057,
    "category": "classroom"
  },

  {
    "name": "7-JHAN MARIE",
    "type": "facility",
    "lat":15.65986077712253,
    "lng":        120.7722877370846,
    "category": "classroom"
  },

  {
    "name": "7-HIDEN",
    "type": "facility",
    "lat":    15.659857548812166,
    "lng":     120.77234741623005,
    "category": "classroom"
  },

   {
    "name": "7-KATRINA",
    "type": "facility",
    "lat":    15.659860131460468,
    "lng":     120.77239502543597,
    "category": "classroom"
  },

   {
    "name": "7-JEREMY",
    "type": "facility",
    "lat":    15.6598594857984,
    "lng":      120.77244598740286,
    "category": "classroom"
  },


   {
    "name": "9-CARMELA",
    "type": "facility",
    "lat":  15.660211888828512,
    "lng":      120.77180244625603,
    "category": "classroom"
  },

  {
    "name": "9-LEONARDO",
    "type": "facility",
    "lat": 15.66028767632061,
    "lng":     120.77179960134401,
    "category": "classroom"
  },

   {
    "name": "7-JEVELYN , SP-ICT ROOMS & TVE ROOMS",
    "type": "facility",
    "lat": 15.660234716389335,
    "lng":     120.7719010698731,
    "category": "classroom"
  },

  

{
    "name": "EGG CLASROOM",
    "type": "facility",
    "lat": 15.660140666821672,
    "lng":      120.77202055618993,
    "category": "classroom"
  },

{
    "name": "9-ROCHELLE & BPP",
    "type": "facility",
    "lat": 15.660283110810225,
    "lng":      120.77202150449352,
    "category": "classroom"
  },

  {
    "name": "SPA BULIDING & MAPEH DEPARMENT",
    "type": "facility",
    "lat": 15.660356752256677,
    "lng":      120.77232710399102,
    "category": "classroom"
  },



];

// Calculate bounding box from corners
const BOUNDS = {
  north: Math.max(SCHOOL_BOUNDS.northWest.lat, SCHOOL_BOUNDS.northEast.lat),
  south: Math.min(SCHOOL_BOUNDS.southWest.lat, SCHOOL_BOUNDS.southEast.lat),
  east: Math.max(SCHOOL_BOUNDS.northEast.lng, SCHOOL_BOUNDS.southEast.lng),
  west: Math.min(SCHOOL_BOUNDS.northWest.lng, SCHOOL_BOUNDS.southWest.lng)
};

// Map state
let userLat = null;
let userLng = null;
let userAccuracy = null;
let watchId = null;
let mapImage = null;
let mapContainer = null;
let selectedLocation = null;
let routeLine = null;

// DOM Elements
let youMarker, pickMarker, map, info, locBtn, clearBtn, toggleBtn, searchInput, searchResults, directionsBtn;
let isTracking = false;
let searchResultsList = null;

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log(`âœ“ Loaded ${LOCATIONS.length} locations`);
  initializeMap();
});

function initializeMap() {
  // Get DOM elements
  youMarker = document.getElementById("youMarker");
  pickMarker = document.getElementById("pickMarker");
  map = document.getElementById("map");
  info = document.getElementById("info");
  locBtn = document.getElementById("locBtn");
  clearBtn = document.getElementById("clearBtn");
  toggleBtn = document.getElementById("toggleBtn");
  searchInput = document.getElementById("searchInput");
  searchResults = document.getElementById("searchResults");
  directionsBtn = document.getElementById("directionsBtn");
  mapContainer = document.getElementById("mapContainer");

  // Initialize button with icon only (no text)
  if (locBtn) {
    locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
  }

  // Check if geolocation is supported
  if (!navigator.geolocation) {
    showError("Geolocation is not supported by your browser.");
    if (locBtn) locBtn.disabled = true;
    return;
  }

  // Wait for map image to load
  if (map) {
    map.addEventListener('load', function() {
      mapImage = map;
      console.log('Map image loaded');
      // Auto-get location after map loads
      autoGetLocation();
    });
    
    // If already loaded
    if (map.complete) {
      mapImage = map;
      autoGetLocation();
    }
  }

  // Event listeners
  if (locBtn) {
    locBtn.addEventListener('click', toggleLocationTracking);
  }

  if (clearBtn) {
    clearBtn.addEventListener('click', clearMarkers);
  }

  if (toggleBtn) {
    toggleBtn.addEventListener('click', toggleMapView);
  }

  if (directionsBtn) {
    directionsBtn.addEventListener('click', showDirections);
  }

  // Search functionality
  if (searchInput) {
    searchInput.addEventListener('input', handleSearch);
    searchInput.addEventListener('focus', function() {
      if (searchResults) searchResults.style.display = 'block';
    });
  }

  // Map click handler
  if (mapContainer) {
    mapContainer.addEventListener('click', handleMapClick);
  }

  // Close search results when clicking outside
  document.addEventListener('click', function(e) {
    if (searchResults && !searchResults.contains(e.target) && e.target !== searchInput) {
      searchResults.style.display = 'none';
    }
  });

  // Initial info message
  if (info) {
    info.innerHTML = '<div class="info-hint">Getting your location...</div>';
  }
}

// Auto-get location on page load
function autoGetLocation() {
  if (!USE_REAL_GPS) {
    // Use gate coordinates for testing
    setTimeout(() => {
      const lat = REFERENCE_POINTS.gate.lat;
      const lng = REFERENCE_POINTS.gate.lng;
      updateUserMarker(lat, lng, 5);
      isTracking = true;
      if (locBtn) {
        locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
        locBtn.classList.add('active');
      }
    }, 500);
  } else {
    // Real GPS mode
    if (!navigator.geolocation) return;
    
    const options = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    };

    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const accuracy = position.coords.accuracy;
        updateUserMarker(lat, lng, accuracy);
        isTracking = true;

        // Start watching position
        watchId = navigator.geolocation.watchPosition(
          function(pos) {
            updateUserMarker(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
          },
          function(err) {
            handleGeolocationError(err);
          },
          options
        );

        if (locBtn) {
          locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
          locBtn.classList.add('active');
        }
      },
      function(error) {
        handleGeolocationError(error);
        if (info) {
          info.innerHTML = '<div class="info-hint">Click "Get My Location" to see your position on the map.</div>';
        }
      },
      options
    );
  }
}

// Convert GPS coordinates to pixel position on the blueprint image
function gpsToPixel(lat, lng) {
  if (!map || !map.complete) {
    return { x: 0, y: 0 };
  }

  const rect = mapContainer.getBoundingClientRect();
  const imgWidth = rect.width;
  const imgHeight = rect.height;

  // Calculate relative position within bounds
  const lngPercent = (lng - BOUNDS.west) / (BOUNDS.east - BOUNDS.west);
  const latPercent = (lat - BOUNDS.south) / (BOUNDS.north - BOUNDS.south);

  // Convert to pixel coordinates (invert Y because image coordinates start from top)
  const x = lngPercent * imgWidth;
  const y = (1 - latPercent) * imgHeight; // Invert Y axis

  return { x, y };
}

// Convert pixel position to GPS coordinates
function pixelToGps(x, y) {
  const rect = mapContainer.getBoundingClientRect();
  const imgWidth = rect.width;
  const imgHeight = rect.height;

  // Convert pixel to percentage
  const lngPercent = x / imgWidth;
  const latPercent = 1 - (y / imgHeight); // Invert Y axis

  // Convert to GPS coordinates
  const lng = BOUNDS.west + lngPercent * (BOUNDS.east - BOUNDS.west);
  const lat = BOUNDS.south + latPercent * (BOUNDS.north - BOUNDS.south);

  return { lat, lng };
}

// Check if coordinates are within school bounds
function isWithinSchoolBounds(lat, lng) {
  return lat >= BOUNDS.south && lat <= BOUNDS.north &&
         lng >= BOUNDS.west && lng <= BOUNDS.east;
}

// Calculate distance between two GPS points using Haversine formula
function calculateDistance(lat1, lng1, lat2, lng2) {
  const R = 6371; // Earth's radius in kilometers
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2);
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const distance = R * c; // Distance in kilometers

  // Convert to meters if less than 1km
  if (distance < 1) {
    return (distance * 1000).toFixed(0) + ' m';
  }
  return distance.toFixed(2) + ' km';
}

// Update user marker position
function updateUserMarker(lat, lng, accuracy = null) {
  if (!youMarker) return;

  // Check if within bounds
  if (!isWithinSchoolBounds(lat, lng)) {
    showWarning("You appear to be outside the school campus. Location may not be accurate.");
  }

  userLat = lat;
  userLng = lng;
  userAccuracy = accuracy;

  const position = gpsToPixel(lat, lng);
  
  youMarker.style.left = position.x + 'px';
  youMarker.style.top = position.y + 'px';
  youMarker.style.display = 'block';

  // Update info
  if (info) {
    let accuracyText = '';
    if (accuracy) {
      accuracyText = ` (Accuracy: Â±${Math.round(accuracy)}m)`;
    }
    info.innerHTML = `
      <div class="info-item">
        <strong>Your Location:</strong> 
        <span>Lat ${lat.toFixed(6)}, Lng ${lng.toFixed(6)}</span>
        ${accuracyText}
      </div>
      <div class="info-hint">Click on the map to select a destination.</div>
    `;
  }

  // If destination marker exists, recalculate distance
  if (pickMarker && pickMarker.style.display !== 'none') {
    const pickRect = pickMarker.getBoundingClientRect();
    const mapRect = mapContainer.getBoundingClientRect();
    const pickX = pickRect.left - mapRect.left + pickRect.width / 2;
    const pickY = pickRect.top - mapRect.top + pickRect.height / 2;
    const dest = pixelToGps(pickX, pickY);
    updateDistance(dest.lat, dest.lng);
  }
}

// Handle map click to set destination OR trace pathways
function handleMapClick(e) {
  if (!mapContainer) return;

  const rect = mapContainer.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  // If tracing pathway, add point to current pathway
  if (isTracingPathway && currentPathway) {
    pathwayPoints.push({ x, y });
    drawTracingPreview();
    return;
  }

  // Normal click - place destination marker
  if (pickMarker) {
    pickMarker.style.left = x + 'px';
    pickMarker.style.top = y + 'px';
    pickMarker.style.display = 'block';
  }

  const dest = pixelToGps(x, y);

  // Update info with destination
  if (info) {
    if (userLat !== null && userLng !== null) {
      const distance = calculateDistance(userLat, userLng, dest.lat, dest.lng);
      updateDistance(dest.lat, dest.lng, distance);
    } else {
      info.innerHTML = `
        <div class="info-item">
          <strong>Destination:</strong> 
          <span>Lat ${dest.lat.toFixed(6)}, Lng ${dest.lng.toFixed(6)}</span>
        </div>
        <div class="info-hint">Click "Get My Location" to calculate distance.</div>
      `;
    }
  }
}

// Update distance information
function updateDistance(destLat, destLng, distance = null) {
  if (!info) return;

  if (distance === null && userLat !== null && userLng !== null) {
    distance = calculateDistance(userLat, userLng, destLat, destLng);
  }

  const dest = pixelToGps(
    parseFloat(pickMarker.style.left),
    parseFloat(pickMarker.style.top)
  );

  let accuracyText = '';
  if (userAccuracy) {
    accuracyText = ` (Accuracy: Â±${Math.round(userAccuracy)}m)`;
  }

  info.innerHTML = `
    <div class="info-item">
      <strong>Your Location:</strong> 
      <span>Lat ${userLat.toFixed(6)}, Lng ${userLng.toFixed(6)}</span>
      ${accuracyText}
    </div>
    <div class="info-item">
      <strong>Destination:</strong> 
      <span>Lat ${dest.lat.toFixed(6)}, Lng ${dest.lng.toFixed(6)}</span>
    </div>
    <div class="info-distance">
      <strong>Distance:</strong> <span class="distance-value">${distance}</span>
    </div>
  `;
}

// Toggle location tracking
function toggleLocationTracking() {
  if (isTracking) {
    stopTracking();
  } else {
    startTracking();
  }
}

// Start tracking user location
function startTracking() {
  // Use gate coordinates if not using real GPS
  if (!USE_REAL_GPS) {
    // Show loading state
    if (locBtn) {
      locBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      locBtn.disabled = true;
    }

    // Simulate a small delay for realism
    setTimeout(() => {
      // Use gate coordinates for testing
      const lat = REFERENCE_POINTS.gate.lat;
      const lng = REFERENCE_POINTS.gate.lng;
      const accuracy = 5; // Simulated accuracy in meters

      updateUserMarker(lat, lng, accuracy);

      // Update button
      if (locBtn) {
        locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
        locBtn.disabled = false;
        locBtn.classList.add('active');
      }

      isTracking = true;
    }, 500); // Small delay to simulate GPS request

    return;
  }

  // Real GPS mode
  if (!navigator.geolocation) {
    showError("Geolocation is not supported.");
    return;
  }

  const options = {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 0
  };

  // Show loading state
  if (locBtn) {
    locBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    locBtn.disabled = true;
  }

  // Get current position
  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;

      updateUserMarker(lat, lng, accuracy);

      // Update button
      if (locBtn) {
        locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
        locBtn.disabled = false;
        locBtn.classList.add('active');
      }

      isTracking = true;

      // Start watching position for real-time updates
      watchId = navigator.geolocation.watchPosition(
        function(pos) {
          updateUserMarker(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
        },
        function(err) {
          handleGeolocationError(err);
        },
        options
      );
    },
    function(error) {
      handleGeolocationError(error);
      if (locBtn) {
        locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
        locBtn.disabled = false;
        locBtn.classList.remove('active');
      }
    },
    options
  );
}

// Stop tracking user location
function stopTracking() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  isTracking = false;

  if (locBtn) {
    locBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
    locBtn.classList.remove('active');
  }
}

// Handle geolocation errors
function handleGeolocationError(error) {
  let message = '';
  
  switch(error.code) {
    case error.PERMISSION_DENIED:
      message = "Location access denied. Please allow location permissions in your browser settings.";
      break;
    case error.POSITION_UNAVAILABLE:
      message = "Location information unavailable. Please check your GPS/GPS settings.";
      break;
    case error.TIMEOUT:
      message = "Location request timed out. Please try again.";
      break;
    default:
      message = "An unknown error occurred while getting your location.";
      break;
  }

  showError(message);
}

// Clear all markers
function clearMarkers() {
  if (youMarker) {
    youMarker.style.display = 'none';
  }
  if (pickMarker) {
    pickMarker.style.display = 'none';
  }
  
  // Remove route line
  if (routeLine) {
    routeLine.remove();
    routeLine = null;
  }

  userLat = null;
  userLng = null;
  userAccuracy = null;
  selectedLocation = null;

  if (searchInput) {
    searchInput.value = '';
  }
  if (searchResults) {
    searchResults.style.display = 'none';
  }
  if (directionsBtn) {
    directionsBtn.style.display = 'none';
  }

  if (info) {
    info.innerHTML = '<div class="info-hint">Markers cleared. Your location will be shown automatically.</div>';
  }
}

// Toggle between blueprint and satellite view (if implemented)
function toggleMapView() {
  // This can be extended to switch between final.png and safe.jpg
  if (map && map.src.includes('final.png')) {
    map.src = 'images/safe.jpg';
    if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-map"></i> Blueprint View';
  } else {
    map.src = 'images/final.png';
    if (toggleBtn) toggleBtn.innerHTML = '<i class="fas fa-satellite"></i> Satellite View';
  }
}

// Show error message
function showError(message) {
  if (info) {
    info.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-circle"></i> ${message}</div>`;
  }
  console.error(message);
}

// Show warning message
function showWarning(message) {
  if (info) {
    const currentInfo = info.innerHTML;
    info.innerHTML = `<div class="warning-message"><i class="fas fa-exclamation-triangle"></i> ${message}</div>${currentInfo}`;
  }
  console.warn(message);
}

// Search functionality
function handleSearch(e) {
  const query = e.target.value.toLowerCase().trim();
  
  if (!searchResults) return;

  if (query.length === 0) {
    searchResults.innerHTML = '';
    searchResults.style.display = 'none';
    return;
  }

  // Check if locations exist
  if (!LOCATIONS || LOCATIONS.length === 0) {
    searchResults.innerHTML = '<div class="search-result-item">No locations available. Please add locations to the LOCATIONS array in map.js</div>';
    searchResults.style.display = 'block';
    console.warn('LOCATIONS array is empty.');
    return;
  }

  // Filter locations
  const results = LOCATIONS.filter(location => 
    location.name.toLowerCase().includes(query) ||
    location.type.toLowerCase().includes(query) ||
    location.category.toLowerCase().includes(query)
  ).slice(0, 10); // Limit to 10 results

  console.log(`Searching for "${query}". Found ${results.length} results from ${LOCATIONS.length} locations.`);

  if (results.length === 0) {
    searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
    searchResults.style.display = 'block';
    return;
  }

  // Display results
  searchResults.innerHTML = results.map(location => `
    <div class="search-result-item" data-lat="${location.lat}" data-lng="${location.lng}" data-name="${location.name}">
      <i class="fas fa-${getLocationIcon(location.type)}"></i>
      <div>
        <div class="result-name">${highlightMatch(location.name, query)}</div>
        <div class="result-type">${location.type} â€¢ ${location.category}</div>
      </div>
    </div>
  `).join('');

  searchResults.style.display = 'block';

  // Add click handlers to results
  const resultItems = searchResults.querySelectorAll('.search-result-item');
  resultItems.forEach(item => {
    item.addEventListener('click', function() {
      const lat = parseFloat(this.dataset.lat);
      const lng = parseFloat(this.dataset.lng);
      const name = this.dataset.name;
      selectLocation(lat, lng, name);
      searchInput.value = name;
      searchResults.style.display = 'none';
    });
  });
}

// Highlight matching text in search results
function highlightMatch(text, query) {
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<strong>$1</strong>');
}

// Get icon for location type
function getLocationIcon(type) {
  const icons = {
    'classroom': 'chalkboard-teacher',
    'building': 'building',
    'office': 'briefcase',
    'facility': 'map-marker-alt',
    'entrance': 'door-open'
  };
  return icons[type] || 'map-marker-alt';
}

// Select a location from search
function selectLocation(lat, lng, name) {
  selectedLocation = { lat, lng, name };
  
  // Remove existing route line when selecting new location
  if (routeLine) {
    routeLine.remove();
    routeLine = null;
  }
  
  // Place marker at location
  const position = gpsToPixel(lat, lng);
  if (pickMarker) {
    pickMarker.style.left = position.x + 'px';
    pickMarker.style.top = position.y + 'px';
    pickMarker.style.display = 'block';
  }

  // Update info panel
  if (info) {
    if (userLat !== null && userLng !== null) {
      const distance = calculateDistance(userLat, userLng, lat, lng);
      showLocationInfo(name, lat, lng, distance);
    } else {
      showLocationInfo(name, lat, lng);
    }
  }

  // Show directions button
  if (directionsBtn) {
    directionsBtn.style.display = 'block';
  }
}

// Show location information
function showLocationInfo(name, lat, lng, distance = null) {
  let accuracyText = '';
  if (userAccuracy) {
    accuracyText = ` (Accuracy: Â±${Math.round(userAccuracy)}m)`;
  }

  let distanceHtml = '';
  if (distance) {
    distanceHtml = `
      <div class="info-distance">
        <strong>Distance:</strong> <span class="distance-value">${distance}</span>
      </div>
    `;
  }

  info.innerHTML = `
    <div class="info-item">
      <strong>Your Location:</strong> 
      ${userLat !== null ? `<span>Lat ${userLat.toFixed(6)}, Lng ${userLng.toFixed(6)}</span>${accuracyText}` : '<span>Not available</span>'}
    </div>
    <div class="info-item">
      <strong>Selected:</strong> 
      <span class="location-name">${name}</span>
    </div>
    <div class="info-item">
      <strong>Coordinates:</strong> 
      <span>Lat ${lat.toFixed(6)}, Lng ${lng.toFixed(6)}</span>
    </div>
    ${distanceHtml}
  `;
}

// Find nearest point on any traced pathway
function findNearestPointOnPathways(pixelX, pixelY) {
  let nearest = null;
  let minDistance = Infinity;
  let nearestPathwayId = null;
  let nearestPointIndex = -1;
  
  for (const pathway of TRACED_PATHWAYS) {
    for (let i = 0; i < pathway.points.length; i++) {
      const point = pathway.points[i];
      const dist = Math.sqrt(
        Math.pow(point.x - pixelX, 2) + Math.pow(point.y - pixelY, 2)
      );
      
      if (dist < minDistance) {
        minDistance = dist;
        nearest = point;
        nearestPathwayId = pathway.id;
        nearestPointIndex = i;
      }
    }
  }
  
  return nearest ? { 
    point: nearest, 
    pathwayId: nearestPathwayId, 
    pointIndex: nearestPointIndex, 
    distance: minDistance 
  } : null;
}

// Find connection point between two pathways (returns the point indices)
function findPathwayConnection(pathway1, pathway2, tolerance = 10) {
  let bestConnection = null;
  let minDistance = Infinity;
  
  for (let i = 0; i < pathway1.points.length; i++) {
    const p1 = pathway1.points[i];
    for (let j = 0; j < pathway2.points.length; j++) {
      const p2 = pathway2.points[j];
      const dist = Math.sqrt(
        Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2)
      );
      if (dist < tolerance && dist < minDistance) {
        minDistance = dist;
        bestConnection = { pathway1Index: i, pathway2Index: j, point: p1, distance: dist };
      }
    }
  }
  return bestConnection;
}

// Check if two pathways connect (share a point within tolerance)
function pathwaysConnect(pathway1, pathway2, tolerance = 10) {
  return findPathwayConnection(pathway1, pathway2, tolerance) !== null;
}

// Build graph from traced pathways with connection info
function buildTracedPathwayGraph() {
  const graph = {};
  
  // Initialize nodes (each pathway is a node)
  for (const pathway of TRACED_PATHWAYS) {
    graph[pathway.id] = {
      pathway: pathway,
      neighbors: []
    };
  }
  
  // Connect pathways that share points and store connection info
  for (let i = 0; i < TRACED_PATHWAYS.length; i++) {
    for (let j = i + 1; j < TRACED_PATHWAYS.length; j++) {
      const connection = findPathwayConnection(TRACED_PATHWAYS[i], TRACED_PATHWAYS[j]);
      if (connection) {
        graph[TRACED_PATHWAYS[i].id].neighbors.push({
          pathwayId: TRACED_PATHWAYS[j].id,
          pathway: TRACED_PATHWAYS[j],
          connectionIndex: connection.pathway1Index, // Index on pathway1 where they connect
          neighborConnectionIndex: connection.pathway2Index // Index on pathway2 where they connect
        });
        graph[TRACED_PATHWAYS[j].id].neighbors.push({
          pathwayId: TRACED_PATHWAYS[i].id,
          pathway: TRACED_PATHWAYS[i],
          connectionIndex: connection.pathway2Index, // Index on pathway2 where they connect
          neighborConnectionIndex: connection.pathway1Index // Index on pathway1 where they connect
        });
      }
    }
  }
  
  return graph;
}

// Find route through traced pathways using pathfinding
function findRouteThroughTracedPathways(startLat, startLng, endLat, endLng) {
  if (TRACED_PATHWAYS.length === 0) {
    console.log('No traced pathways available');
    return null;
  }
  
  const startPixel = gpsToPixel(startLat, startLng);
  const endPixel = gpsToPixel(endLat, endLng);
  
  let startNearest = findNearestPointOnPathways(startPixel.x, startPixel.y);
  let endNearest = findNearestPointOnPathways(endPixel.x, endPixel.y);
  
  console.log('Start nearest:', startNearest);
  console.log('End nearest:', endNearest);
  
  if (!startNearest || !endNearest) {
    console.warn('Could not find nearest pathways. Start distance:', startNearest?.distance, 'End distance:', endNearest?.distance);
    // Try with larger search radius - find nearest pathway even if point is far
    if (!startNearest) {
      let minDist = Infinity;
      let nearestPathway = null;
      let nearestIdx = -1;
      for (const pathway of TRACED_PATHWAYS) {
        for (let i = 0; i < pathway.points.length; i++) {
          const point = pathway.points[i];
          const dist = Math.sqrt(
            Math.pow(point.x - startPixel.x, 2) + Math.pow(point.y - startPixel.y, 2)
          );
          if (dist < minDist) {
            minDist = dist;
            nearestPathway = pathway;
            nearestIdx = i;
          }
        }
      }
      if (nearestPathway) {
        console.log('Using fallback start pathway:', nearestPathway.id, 'distance:', minDist);
        startNearest = { point: nearestPathway.points[nearestIdx], pathwayId: nearestPathway.id, pointIndex: nearestIdx, distance: minDist };
      }
    }
    
    if (!endNearest) {
      let minDist = Infinity;
      let nearestPathway = null;
      let nearestIdx = -1;
      for (const pathway of TRACED_PATHWAYS) {
        for (let i = 0; i < pathway.points.length; i++) {
          const point = pathway.points[i];
          const dist = Math.sqrt(
            Math.pow(point.x - endPixel.x, 2) + Math.pow(point.y - endPixel.y, 2)
          );
          if (dist < minDist) {
            minDist = dist;
            nearestPathway = pathway;
            nearestIdx = i;
          }
        }
      }
      if (nearestPathway) {
        console.log('Using fallback end pathway:', nearestPathway.id, 'distance:', minDist);
        endNearest = { point: nearestPathway.points[nearestIdx], pathwayId: nearestPathway.id, pointIndex: nearestIdx, distance: minDist };
      }
    }
    
    if (!startNearest || !endNearest) {
      console.error('Still could not find pathways');
      return null;
    }
  }
  
  const startPathwayId = startNearest.pathwayId;
  const endPathwayId = endNearest.pathwayId;
  
  // If same pathway, use it directly
  if (startPathwayId === endPathwayId) {
    const pathway = TRACED_PATHWAYS.find(p => p.id === startPathwayId);
    const startIdx = startNearest.pointIndex;
    const endIdx = endNearest.pointIndex;
    
    const path = [{ lat: startLat, lng: startLng }];
    
    const minIdx = Math.min(startIdx, endIdx);
    const maxIdx = Math.max(startIdx, endIdx);
    
    for (let i = minIdx; i <= maxIdx; i++) {
      const point = pathway.points[i];
      const gps = pixelToGps(point.x, point.y);
      path.push(gps);
    }
    
    path.push({ lat: endLat, lng: endLng });
    console.log('Same pathway route:', path.length, 'points');
    return path;
  }
  
  // Different pathways - use pathfinding
  const graph = buildTracedPathwayGraph();
  console.log('Pathway graph:', Object.keys(graph).length, 'pathways');
  console.log('Start pathway neighbors:', graph[startPathwayId]?.neighbors.length);
  console.log('End pathway neighbors:', graph[endPathwayId]?.neighbors.length);
  
  // A* pathfinding through pathway graph
  const openSet = [{ pathwayId: startPathwayId, g: 0, f: 0 }];
  const closedSet = new Set();
  const cameFrom = {};
  const gScore = { [startPathwayId]: 0 };
  
  // Heuristic: distance between pathway centers
  const startPathway = TRACED_PATHWAYS.find(p => p.id === startPathwayId);
  const endPathway = TRACED_PATHWAYS.find(p => p.id === endPathwayId);
  const startCenter = {
    x: startPathway.points[Math.floor(startPathway.points.length / 2)].x,
    y: startPathway.points[Math.floor(startPathway.points.length / 2)].y
  };
  const endCenter = {
    x: endPathway.points[Math.floor(endPathway.points.length / 2)].x,
    y: endPathway.points[Math.floor(endPathway.points.length / 2)].y
  };
  const hStart = Math.sqrt(
    Math.pow(startCenter.x - endCenter.x, 2) + Math.pow(startCenter.y - endCenter.y, 2)
  );
  const fScore = { [startPathwayId]: hStart };
  
  while (openSet.length > 0) {
    openSet.sort((a, b) => {
      const fA = fScore[a.pathwayId] || Infinity;
      const fB = fScore[b.pathwayId] || Infinity;
      return fA - fB;
    });
    
    const current = openSet.shift();
    
    if (current.pathwayId === endPathwayId) {
      // Reconstruct path
      const pathwaySequence = [];
      let currentNodeId = endPathwayId;
      
      while (currentNodeId !== startPathwayId) {
        const pathway = TRACED_PATHWAYS.find(p => p.id === currentNodeId);
        pathwaySequence.unshift(pathway);
        const prevId = cameFrom[currentNodeId];
        if (!prevId) break;
        currentNodeId = prevId;
      }
      
      // Add start pathway
      const startPath = TRACED_PATHWAYS.find(p => p.id === startPathwayId);
      pathwaySequence.unshift(startPath);
      
      // Build route points following pathways properly
      const path = [{ lat: startLat, lng: startLng }];
      
      // Find connection points between pathways
      const connections = [];
      for (let i = 0; i < pathwaySequence.length - 1; i++) {
        const conn = findPathwayConnection(pathwaySequence[i], pathwaySequence[i + 1]);
        if (conn) {
          connections.push({
            pathway1Index: conn.pathway1Index,
            pathway2Index: conn.pathway2Index
          });
        }
      }
      
      // Add points from start pathway (from nearest point to connection point)
      const startPathway = pathwaySequence[0];
      const startIdx = startNearest.pointIndex;
      
      let targetIdx;
      if (pathwaySequence.length > 1 && connections.length > 0) {
        // Go to connection point with next pathway
        targetIdx = connections[0].pathway1Index;
      } else {
        // Same pathway or no connections, go to end point
        targetIdx = endNearest.pointIndex;
      }
      
      // Traverse start pathway in correct direction
      if (startIdx <= targetIdx) {
        for (let i = startIdx; i <= targetIdx; i++) {
          const point = startPathway.points[i];
          const gps = pixelToGps(point.x, point.y);
          path.push(gps);
        }
      } else {
        for (let i = startIdx; i >= targetIdx; i--) {
          const point = startPathway.points[i];
          const gps = pixelToGps(point.x, point.y);
          path.push(gps);
        }
      }
      
      // Add points from intermediate pathways (from connection to connection)
      for (let p = 1; p < pathwaySequence.length - 1; p++) {
        const pathway = pathwaySequence[p];
        const fromIdx = connections[p - 1].pathway2Index; // Connection from previous pathway
        const toIdx = connections[p].pathway1Index; // Connection to next pathway
        
        // Traverse in correct direction
        if (fromIdx <= toIdx) {
          for (let i = fromIdx; i <= toIdx; i++) {
            const point = pathway.points[i];
            const gps = pixelToGps(point.x, point.y);
            // Avoid duplicates (check last point)
            const lastPoint = path[path.length - 1];
            const dist = Math.sqrt(
              Math.pow(point.x - (gpsToPixel(lastPoint.lat, lastPoint.lng).x), 2) +
              Math.pow(point.y - (gpsToPixel(lastPoint.lat, lastPoint.lng).y), 2)
            );
            if (dist > 2) { // Only add if not too close to last point
              path.push(gps);
            }
          }
        } else {
          for (let i = fromIdx; i >= toIdx; i--) {
            const point = pathway.points[i];
            const gps = pixelToGps(point.x, point.y);
            const lastPoint = path[path.length - 1];
            const dist = Math.sqrt(
              Math.pow(point.x - (gpsToPixel(lastPoint.lat, lastPoint.lng).x), 2) +
              Math.pow(point.y - (gpsToPixel(lastPoint.lat, lastPoint.lng).y), 2)
            );
            if (dist > 2) {
              path.push(gps);
            }
          }
        }
      }
      
      // Add points from end pathway (from connection point to nearest point)
      if (pathwaySequence.length > 1) {
        const endPathway = pathwaySequence[pathwaySequence.length - 1];
        const endIdx = endNearest.pointIndex;
        
        let fromIdx;
        if (connections.length > 0) {
          // Start from connection with previous pathway
          fromIdx = connections[connections.length - 1].pathway2Index;
        } else {
          // No connections, start from beginning
          fromIdx = 0;
        }
        
        // Traverse in correct direction
        if (fromIdx <= endIdx) {
          for (let i = fromIdx; i <= endIdx; i++) {
            const point = endPathway.points[i];
            const gps = pixelToGps(point.x, point.y);
            const lastPoint = path[path.length - 1];
            const dist = Math.sqrt(
              Math.pow(point.x - (gpsToPixel(lastPoint.lat, lastPoint.lng).x), 2) +
              Math.pow(point.y - (gpsToPixel(lastPoint.lat, lastPoint.lng).y), 2)
            );
            if (dist > 2) {
              path.push(gps);
            }
          }
        } else {
          for (let i = fromIdx; i >= endIdx; i--) {
            const point = endPathway.points[i];
            const gps = pixelToGps(point.x, point.y);
            const lastPoint = path[path.length - 1];
            const dist = Math.sqrt(
              Math.pow(point.x - (gpsToPixel(lastPoint.lat, lastPoint.lng).x), 2) +
              Math.pow(point.y - (gpsToPixel(lastPoint.lat, lastPoint.lng).y), 2)
            );
            if (dist > 2) {
              path.push(gps);
            }
          }
        }
      }
      
      path.push({ lat: endLat, lng: endLng });
      
      console.log('Multi-pathway route found:', pathwaySequence.length, 'pathways,', path.length, 'points');
      return path;
    }
    
    closedSet.add(current.pathwayId);
    
    // Check neighbors
    const currentNode = graph[current.pathwayId];
    for (const neighbor of currentNode.neighbors) {
      if (closedSet.has(neighbor.pathwayId)) continue;
      
      const tentativeG = gScore[current.pathwayId] + 1; // Each pathway = 1 step
      
      if (!gScore[neighbor.pathwayId] || tentativeG < gScore[neighbor.pathwayId]) {
        cameFrom[neighbor.pathwayId] = current.pathwayId;
        gScore[neighbor.pathwayId] = tentativeG;
        
        const neighborPathway = neighbor.pathway;
        const neighborCenter = {
          x: neighborPathway.points[Math.floor(neighborPathway.points.length / 2)].x,
          y: neighborPathway.points[Math.floor(neighborPathway.points.length / 2)].y
        };
        const h = Math.sqrt(
          Math.pow(neighborCenter.x - endCenter.x, 2) + Math.pow(neighborCenter.y - endCenter.y, 2)
        );
        fScore[neighbor.pathwayId] = tentativeG + h;
        
        if (!openSet.find(n => n.pathwayId === neighbor.pathwayId)) {
          openSet.push({ pathwayId: neighbor.pathwayId, g: tentativeG, f: fScore[neighbor.pathwayId] });
        }
      }
    }
  }
  
  console.warn('No path found through traced pathways');
  console.log('Start pathway:', startPathwayId, 'End pathway:', endPathwayId);
  console.log('Graph connections:', Object.keys(graph).map(id => ({
    id,
    neighbors: graph[id].neighbors.map(n => n.pathwayId)
  })));
  
  // Last resort: try to use the start and end pathways individually
  // even if they're not connected, at least follow the pathways partially
  console.log('Attempting fallback: using start and end pathways individually');
  const startPathwayFallback = TRACED_PATHWAYS.find(p => p.id === startPathwayId);
  const endPathwayFallback = TRACED_PATHWAYS.find(p => p.id === endPathwayId);
  
  if (startPathwayFallback && endPathwayFallback) {
    const path = [{ lat: startLat, lng: startLng }];
    
    // Add points from start pathway (from nearest point to end)
    const startIdx = startNearest.pointIndex;
    for (let i = startIdx; i < startPathwayFallback.points.length; i++) {
      const point = startPathwayFallback.points[i];
      const gps = pixelToGps(point.x, point.y);
      path.push(gps);
    }
    
    // Add points from end pathway (from start to nearest point)
    const endIdx = endNearest.pointIndex;
    for (let i = 0; i <= endIdx; i++) {
      const point = endPathwayFallback.points[i];
      const gps = pixelToGps(point.x, point.y);
      path.push(gps);
    }
    
    path.push({ lat: endLat, lng: endLng });
    console.log('Fallback route created:', path.length, 'points');
    return path;
  }
  
  return null;
}

// Show directions (route visualization)
function showDirections() {
  if (!selectedLocation || userLat === null || userLng === null) {
    showError("Please select a location and ensure your location is available.");
    return;
  }

  // Remove existing route line
  if (routeLine) {
    routeLine.remove();
    routeLine = null;
  }
  
  const existingRoutes = mapContainer.querySelectorAll('.route-line, svg.route-svg');
  existingRoutes.forEach(route => route.remove());

  // Ensure mapContainer has position relative
  if (mapContainer) {
    const containerStyle = window.getComputedStyle(mapContainer);
    if (containerStyle.position === 'static') {
      mapContainer.style.position = 'relative';
    }
  }

  // Try to find route through traced pathways first
  const tracedPath = findRouteThroughTracedPathways(
    userLat, userLng,
    selectedLocation.lat, selectedLocation.lng
  );
  
  if (tracedPath && tracedPath.length > 1) {
    // Draw route following traced pathways
    console.log('Using traced pathway route with', tracedPath.length, 'points');
    
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.style.position = 'absolute';
    svg.style.top = '0';
    svg.style.left = '0';
    svg.style.width = '100%';
    svg.style.height = '100%';
    svg.style.pointerEvents = 'none';
    svg.style.zIndex = '15';
    svg.setAttribute('class', 'route-svg');
    
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    let pathData = '';
    
    for (let i = 0; i < tracedPath.length; i++) {
      const pixelPos = gpsToPixel(tracedPath[i].lat, tracedPath[i].lng);
      if (i === 0) {
        pathData += `M ${pixelPos.x} ${pixelPos.y}`;
      } else {
        pathData += ` L ${pixelPos.x} ${pixelPos.y}`;
      }
    }
    
    path.setAttribute('d', pathData);
    path.setAttribute('stroke', '#ff6b00');
    path.setAttribute('stroke-width', '6');
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke-linecap', 'round');
    path.setAttribute('stroke-linejoin', 'round');
    path.setAttribute('opacity', '0.9');
    path.style.filter = 'drop-shadow(0 2px 4px rgba(255, 107, 0, 0.6))';
    
    svg.appendChild(path);
    mapContainer.appendChild(svg);
    routeLine = svg;
    
    // Calculate distance along path
    let totalDistance = 0;
    for (let i = 0; i < tracedPath.length - 1; i++) {
      const dist = calculateDistance(
        tracedPath[i].lat, tracedPath[i].lng,
        tracedPath[i + 1].lat, tracedPath[i + 1].lng
      );
      const distMeters = parseFloat(dist.replace(' m', '').replace(' km', '')) * (dist.includes('km') ? 1000 : 1);
      totalDistance += distMeters;
    }
    
    const distanceText = totalDistance < 1000 ? totalDistance.toFixed(0) + ' m' : (totalDistance / 1000).toFixed(2) + ' km';
    
    if (info) {
      let accuracyText = '';
      if (userAccuracy) {
        accuracyText = ` (Accuracy: Â±${Math.round(userAccuracy)}m)`;
      }

      info.innerHTML = `
        <div class="info-item">
          <strong>Your Location:</strong> 
          <span>Lat ${userLat.toFixed(6)}, Lng ${userLng.toFixed(6)}</span>${accuracyText}
        </div>
        <div class="info-item">
          <strong>Destination:</strong> 
          <span class="location-name">${selectedLocation.name}</span>
        </div>
        <div class="info-distance">
          <strong>Distance:</strong> <span class="distance-value">${distanceText}</span>
        </div>
        <div class="info-hint">
          <i class="fas fa-route"></i> Route follows traced pathways
        </div>
      `;
    }
    
    return;
  }

  // Fallback to straight line if no traced pathways
  const startPos = gpsToPixel(userLat, userLng);
  const endPos = gpsToPixel(selectedLocation.lat, selectedLocation.lng);

  routeLine = document.createElement('div');
  routeLine.className = 'route-line';
  
  const dx = endPos.x - startPos.x;
  const dy = endPos.y - startPos.y;
  const length = Math.sqrt(dx * dx + dy * dy);
  const angle = Math.atan2(dy, dx) * 180 / Math.PI;

  routeLine.style.position = 'absolute';
  routeLine.style.pointerEvents = 'none';
  routeLine.style.zIndex = '15';
  routeLine.style.width = length + 'px';
  routeLine.style.height = '6px';
  routeLine.style.backgroundColor = '#ff6b00';
  routeLine.style.left = startPos.x + 'px';
  routeLine.style.top = (startPos.y - 3) + 'px';
  routeLine.style.transformOrigin = '0 50%';
  routeLine.style.transform = `rotate(${angle}deg)`;
  routeLine.style.boxShadow = '0 2px 8px rgba(255, 107, 0, 0.6)';
  routeLine.style.borderRadius = '3px';
  routeLine.style.opacity = '0.9';

  mapContainer.appendChild(routeLine);

  const distance = calculateDistance(userLat, userLng, selectedLocation.lat, selectedLocation.lng);
  const bearing = calculateBearing(userLat, userLng, selectedLocation.lat, selectedLocation.lng);
  const direction = getDirectionText(bearing);

  if (info) {
    let accuracyText = '';
    if (userAccuracy) {
      accuracyText = ` (Accuracy: Â±${Math.round(userAccuracy)}m)`;
    }

    info.innerHTML = `
      <div class="info-item">
        <strong>Your Location:</strong> 
        <span>Lat ${userLat.toFixed(6)}, Lng ${userLng.toFixed(6)}</span>${accuracyText}
      </div>
      <div class="info-item">
        <strong>Destination:</strong> 
        <span class="location-name">${selectedLocation.name}</span>
      </div>
      <div class="info-distance">
        <strong>Distance:</strong> <span class="distance-value">${distance}</span>
      </div>
      <div class="info-item">
        <strong>Direction:</strong> <span>${direction}</span>
      </div>
      <div class="info-hint">
        <i class="fas fa-route"></i> Direct route (trace pathways to follow black lines)
      </div>
    `;
  }
}

// Calculate bearing between two points
function calculateBearing(lat1, lng1, lat2, lng2) {
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const lat1Rad = lat1 * Math.PI / 180;
  const lat2Rad = lat2 * Math.PI / 180;

  const y = Math.sin(dLng) * Math.cos(lat2Rad);
  const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - 
           Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);

  const bearing = Math.atan2(y, x) * 180 / Math.PI;
  return (bearing + 360) % 360;
}

// Get direction text from bearing
function getDirectionText(bearing) {
  const directions = ['North', 'Northeast', 'East', 'Southeast', 'South', 'Southwest', 'West', 'Northwest'];
  const index = Math.round(bearing / 45) % 8;
  return directions[index];
}

